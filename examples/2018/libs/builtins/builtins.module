# builtins.module

# builtins module is included by all opmodes!
#
# All names within this modules are available to all modules!

module

use cycle
use telemetry

type subr_t is subroutine

type label_t is label
type label_l_t is label taking label_t
type label_s_t is label taking subr_t

type p_config_s_t is subroutine taking ?c_yield: label_s_t ?c_done: label_t
                                    -> ?c_config: c_config_t

type c_config_t is subroutine taking ?p_next: label_t ?p_done: subr_t
                                  -> ?p_config: p_config_s_t


# FIX: temporary
var isAlive? is boolean
var isActive? is boolean
var isStarted? is boolean


label abort message$
    # FIX
    #`fprintf(stderr, "%s\n", ` message$ `);`
    #`exit(1);`


function get_subroutines_by_name name$ returning p_config_s_t
  goto return_label p_config

  subroutine p_config ?c_yield: c_yield ?c_done: c_done ?c_config: c_config
    var c_yield is label_s_t
    var c_done is label_t
    var c_config is c_config_t
    # FIX: how to make this optional?
    c_config p_next: next_routine p_done: p_done
    set imodule_index to: 0
    set ilabel_index to: 0
    return

  label next_module
    ======================================================================
    | YN | imodule_index < {iget_num_modules}
    ======================================================================
    | X  | set ilabel_index to: 0
    |    | goto next_routine
    |  X | done with: get_subroutines_by_name
    |    | goto c_done
    ======================================================================

  subroutine p_done
    done with: get_subroutines_by_name
    return

  label next_routine
    ======================================================================
    | YN | ilabel_index < {iget_num_labels imodule_index}
    ======================================================================
    | X  | continue
    |  X | goto next_module
    ======================================================================

    ======================================================================
    | YN | {get_label_name$ imodule_index ilabel_index} == name$
    ======================================================================
    | X  | set i to: ilabel_index
    |    | ilabel_index += 1
    |    | goto c_yield {get_subr imodule_index i}
    |  X | ilabel_index += 1
    |    | goto next_routine
    ======================================================================


function iget_num_modules
    # FIX
    #return `__num_modules__`
    return 2


function iget_num_labels imodule
    # FIX
    # FIX: Verify range of imodule?
    #return `__module_instances__[` imodule `]->num_labels`
    return 1


function get_label_name$ imodule ilabel
    # FIX
    # FIX: Verify range of imodule and ilabel?
    #return `__module_instances__[` imodule `]->labels[` ilabel `]->name`
    return "bob"


function get_subr imodule ilabel returning subr_t
    # FIX
    # FIX: Verify range of imodule and ilabel?
    # FIX: Should verify that the returned label is a subr_t...
    #return `__module_instances__[` imodule `]->labels[` ilabel `]`
